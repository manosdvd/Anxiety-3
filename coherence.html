<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Coherence - Rhythmic Flow</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@400;700&display=swap');

    html, body, #root {
      height: 100%;
      height: 100dvh;
      margin: 0;
      overflow: hidden;
    }

    body {
      background-color: #0f0f0f;
      color: #ffffff;
      font-family: 'Roboto Mono', monospace;
      touch-action: none;
    }

    /* CRT Scanline effect */
    .scanlines {
      background: linear-gradient(to bottom,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 0) 50%,
          rgba(0, 0, 0, 0.2) 50%,
          rgba(0, 0, 0, 0.2));
      background-size: 100% 4px;
      position: absolute;
      top: 0; right: 0; bottom: 0; left: 0;
      pointer-events: none;
      z-index: 50;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(10, 1fr);
      gap: 4px;
      width: 100%;
      height: 100%;
      max-width: 65vh;
      margin: 0 auto;
      position: relative;
      z-index: 10;
    }

    .orb {
      border-radius: 50%;
      transition: transform 0.3s ease-out, box-shadow 0.3s ease, opacity 0.3s ease;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }

    .orb.active {
      transform: scale(1.1);
      box-shadow: 0 0 15px currentColor;
      z-index: 20;
    }

    .orb.dim {
      opacity: 0.3;
      transform: scale(0.8);
    }

    .breath-circle {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      border: 2px solid rgba(34, 211, 238, 0.3); /* Cyan border */
      box-shadow: 0 0 20px rgba(34, 211, 238, 0.1);
      pointer-events: none;
      transition: width 0.1s linear, height 0.1s linear, opacity 0.1s linear;
      z-index: 0;
    }

    /* Connecting Line SVG Overlay */
    .connections-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 15;
    }

    .particle {
      position: absolute;
      pointer-events: none;
      border-radius: 50%;
      animation: drift 2s ease-out forwards;
    }

    @keyframes drift {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0.8; }
      100% { transform: translate(var(--tx), var(--ty)) scale(1.5); opacity: 0; }
    }

    .text-glow {
        text-shadow: 0 0 10px rgba(34, 211, 238, 0.5);
    }

    .fade-in { animation: fadeIn 0.5s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -40%); } to { opacity: 1; transform: translate(-50%, -50%); } }

  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;

    // --- Audio System (Ambient/Harmonic) ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    // Pentatonic Scale
    const FREQUENCIES = [
      261.63, 293.66, 329.63, 392.00, 440.00, // 4
      523.25, 587.33, 659.25, 783.99, 880.00, // 5
      1046.50 // 6
    ];

    const playTone = (index, duration = 1.5, volume = 0.1, soundOn = true) => {
      if (!soundOn) return;
      if (audioCtx.state === 'suspended') audioCtx.resume();

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      const freq = FREQUENCIES[index % FREQUENCIES.length];
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(0, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(volume, audioCtx.currentTime + 0.1);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + duration);
    };

    const playChord = (count, soundOn) => {
        const base = Math.floor(Math.random() * 3);
        playTone(base, 2, 0.15, soundOn);
        if (count > 3) setTimeout(() => playTone(base + 2, 2, 0.1, soundOn), 100);
        if (count > 5) setTimeout(() => playTone(base + 4, 2, 0.1, soundOn), 200);
    };

    const playPop = (soundOn) => playTone(10, 0.3, 0.05, soundOn);

    // --- Icons ---
    const IconPause = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16" /><rect x="14" y="4" width="4" height="16" /></svg>;
    const IconVolume = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" /><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" /></svg>;
    const IconVolumeOff = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="1" y1="1" x2="23" y2="23" /><path d="M9 9v6a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6" /></svg>;
    const IconZap = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></svg>;
    const IconMonitor = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="3" width="20" height="14" rx="2" ry="2" /><line x1="8" y1="21" x2="16" y2="21" /><line x1="12" y1="17" x2="12" y2="21" /></svg>;
    const IconEye = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></svg>;
    const IconBack = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" /></svg>;

    // --- Constants ---
    const ROWS = 10;
    const COLS = 8;
    // Neon-Pastel Palette for "Cyber-Zen"
    const COLORS = [
      '#22d3ee', // Cyan
      '#f472b6', // Pink
      '#a78bfa', // Purple
      '#34d399', // Emerald
      '#fbbf24', // Amber
      '#60a5fa', // Blue
    ];

    const App = () => {
      // --- State ---
      const [settings, setSettings] = useState({ sound: true, haptics: true, crt: true, colorBlind: false });
      const [grid, setGrid] = useState([]);
      const [path, setPath] = useState([]); // Array of {r, c}
      const [isDragging, setIsDragging] = useState(false);
      const [score, setScore] = useState(0);
      const [highScore, setHighScore] = useState(parseInt(localStorage.getItem('coherence_highscore')) || 0);
      const [breathPhase, setBreathPhase] = useState(0);
      const [breathValue, setBreathValue] = useState(0);
      const [particles, setParticles] = useState([]);
      const [message, setMessage] = useState(null);
      const [isPaused, setIsPaused] = useState(false);
      const [gameStarted, setGameStarted] = useState(false);

      const gridRef = useRef(null);

      // --- Breath Loop ---
      useEffect(() => {
        let start = Date.now();
        const cycleDuration = 8000;

        const tick = () => {
          if (isPaused) {
              start = Date.now() - (breathPhase * cycleDuration);
              requestAnimationFrame(tick);
              return;
          }

          const now = Date.now();
          const elapsed = (now - start) % cycleDuration;
          const phase = elapsed / cycleDuration;

          setBreathPhase(phase);
          const val = (Math.sin((phase * Math.PI * 2) - (Math.PI / 2)) + 1) / 2;
          setBreathValue(val);

          requestAnimationFrame(tick);
        };
        const anim = requestAnimationFrame(tick);
        return () => cancelAnimationFrame(anim);
      }, [isPaused]);

      // --- Init ---
      const initGame = useCallback(() => {
        const newGrid = [];
        for(let r=0; r<ROWS; r++) {
            const row = [];
            for(let c=0; c<COLS; c++) {
                row.push({
                    id: Math.random().toString(36).substr(2,9),
                    color: COLORS[Math.floor(Math.random() * COLORS.length)],
                    r, c,
                    scale: 1
                });
            }
            newGrid.push(row);
        }
        setGrid(newGrid);
        setScore(0);
        setPath([]);
        setGameStarted(true);
        setIsPaused(false);
      }, []);

      // --- Interaction ---
      const getCellFromPoint = (x, y) => {
          if (!gridRef.current) return null;
          const el = document.elementFromPoint(x, y);
          // Traverse up to find data attributes if clicked on inner orb
          let target = el;
          while (target && !target.dataset.r) {
             target = target.parentElement;
             if (target === gridRef.current) return null;
          }
          if (target && target.dataset.r) {
              return { r: parseInt(target.dataset.r), c: parseInt(target.dataset.c) };
          }
          return null;
      };

      const handleStart = (r, c) => {
          if (!gameStarted || isPaused) return;
          setIsDragging(true);
          setPath([{r, c, color: grid[r][c].color}]);
          playPop(settings.sound);
      };

      const handleMove = (e) => {
          if (!isDragging || !gameStarted || isPaused) return;

          let clientX, clientY;
          if (e.touches) {
              clientX = e.touches[0].clientX;
              clientY = e.touches[0].clientY;
          } else {
              clientX = e.clientX;
              clientY = e.clientY;
          }

          const cell = getCellFromPoint(clientX, clientY);
          if (cell) {
              const last = path[path.length - 1];
              const isAdjacent = Math.abs(cell.r - last.r) <= 1 && Math.abs(cell.c - last.c) <= 1;
              const isSame = cell.r === last.r && cell.c === last.c;
              const alreadyVisited = path.some(p => p.r === cell.r && p.c === cell.c);

              if (!isSame && isAdjacent && !alreadyVisited) {
                  if (grid[cell.r][cell.c].color === path[0].color) {
                      setPath(prev => [...prev, {r: cell.r, c: cell.c, color: grid[cell.r][cell.c].color}]);
                      playPop(settings.sound);
                      if (settings.haptics && navigator.vibrate) navigator.vibrate(5);
                  }
              } else if (path.length > 1 && cell.r === path[path.length-2].r && cell.c === path[path.length-2].c) {
                  setPath(prev => prev.slice(0, -1));
              }
          }
      };

      const handleEnd = () => {
          if (!isDragging) return;
          setIsDragging(false);
          if (path.length >= 3) completeMatch();
          else setPath([]);
      };

      const completeMatch = () => {
          let points = path.length * 10;
          let coherenceBonus = 1;
          let bonusText = "";

          if (breathValue < 0.3) {
              coherenceBonus = 2.0;
              bonusText = "PERFECT FLOW";
          } else if (breathValue < 0.6) {
              coherenceBonus = 1.5;
              bonusText = "GOOD SYNC";
          }

          points = Math.floor(points * coherenceBonus);
          setScore(s => s + points);
          if (score + points > highScore) {
              setHighScore(score + points);
              localStorage.setItem('coherence_highscore', score + points);
          }

          playChord(path.length, settings.sound);
          if (bonusText) showMessage(bonusText);

          const newGrid = [...grid.map(row => [...row])];
          path.forEach(p => {
             createParticles(p.r, p.c, p.color);
             newGrid[p.r][p.c] = {
                  ...newGrid[p.r][p.c],
                  id: Math.random(),
                  color: COLORS[Math.floor(Math.random() * COLORS.length)],
                  scale: 0
              };
          });

          setGrid(newGrid);
          setPath([]);

          setTimeout(() => {
              setGrid(curr => {
                  const g = curr.map(row => [...row]);
                  path.forEach(p => {
                      if (g[p.r][p.c]) g[p.r][p.c].scale = 1;
                  });
                  return g;
              });
          }, 50);
      };

      const createParticles = (r, c, color) => {
          const newParts = [];
          for(let i=0; i<5; i++) {
              const angle = Math.random() * Math.PI * 2;
              const dist = 50 + Math.random() * 50;
              newParts.push({
                  id: Math.random(),
                  top: (r * 10) + 5 + '%',
                  left: (c * 12.5) + 6.25 + '%',
                  color,
                  tx: Math.cos(angle) * dist + 'px',
                  ty: Math.sin(angle) * dist + 'px'
              });
          }
          setParticles(prev => [...prev, ...newParts]);
          setTimeout(() => setParticles(prev => prev.slice(5)), 1000);
      };

      const showMessage = (text) => {
          const id = Math.random();
          setMessage({ id, text });
          setTimeout(() => setMessage(null), 2000);
      };

      const getSvgPath = () => {
          if (path.length < 2) return "";
          const getXY = (r, c) => {
              const x = (c * 12.5) + 6.25;
              const y = (r * 10) + 5;
              return `${x}% ${y}%`;
          };
          let d = `M ${getXY(path[0].r, path[0].c)}`;
          for(let i=1; i<path.length; i++) {
              d += ` L ${getXY(path[i].r, path[i].c)}`;
          }
          return d;
      };

      // --- UI Handlers ---
      const togglePause = () => setIsPaused(prev => !prev);
      const toggleSound = () => setSettings(s => ({ ...s, sound: !s.sound }));
      const toggleHaptics = () => setSettings(s => ({ ...s, haptics: !s.haptics }));
      const toggleCRT = () => setSettings(s => ({ ...s, crt: !s.crt }));
      const toggleColorBlind = () => setSettings(s => ({ ...s, colorBlind: !s.colorBlind }));

      const SettingBtn = ({ label, active, onClick, icon: Icon }) => (
        <button onClick={onClick} className={`flex items-center justify-between w-full p-3 mb-2 rounded border ${active ? 'bg-cyan-900/50 border-cyan-500 text-white' : 'bg-gray-800 border-gray-700 text-gray-400'}`}>
          <div className="flex items-center gap-2"><Icon /> <span>{label}</span></div>
          <span className="font-bold">{active ? 'ON' : 'OFF'}</span>
        </button>
      );

      return (
        <div
            className={`w-full h-full relative overflow-hidden select-none bg-gray-900 text-white font-mono`}
            onTouchMove={handleMove}
            onTouchEnd={handleEnd}
            onMouseMove={handleMove}
            onMouseUp={handleEnd}
        >
          {settings.crt && <div className="scanlines"></div>}

          {/* Breath Visual (Behind Grid) */}
          <div
            className="breath-circle"
            style={{
                width: `${40 + (breathValue * 40)}vh`,
                height: `${40 + (breathValue * 40)}vh`,
                opacity: 0.2 + (breathValue * 0.3)
            }}
          ></div>

          {/* Top Bar (Matches Anxiety) */}
          <div className="flex-none p-2 z-10 bg-gray-900 border-b-2 border-gray-800 absolute top-0 w-full pointer-events-none">
            <div className="flex justify-between items-center">
              <div className="flex-1">
                <div className="flex items-center gap-2 pointer-events-auto">
                  <a href="index.html" className="text-gray-500 hover:text-white"><IconBack /></a>
                  <h1 className="text-2xl font-black text-cyan-400 tracking-tighter leading-none" style={{ fontFamily: '"Black Ops One", cursive' }}>COHERENCE</h1>
                </div>
                <div className="text-xs text-gray-400 mt-1 font-mono uppercase tracking-widest">
                  {breathValue > 0.8 ? "Inhale..." : breathValue < 0.2 ? "Exhale..." : "Flow..."}
                </div>
              </div>
              <div className="flex items-center gap-4">
                <div className="text-right">
                  <div className="text-[10px] text-gray-400 font-bold">HIGH: {highScore}</div>
                  <div className="text-2xl font-bold text-white leading-none">{score}</div>
                  <div className="text-[10px] text-gray-400">SCORE</div>
                </div>
                {gameStarted && (
                  <button onClick={togglePause} className="p-2 bg-gray-800 rounded border border-gray-600 hover:bg-gray-700 text-white pointer-events-auto">
                    <IconPause />
                  </button>
                )}
              </div>
            </div>
          </div>

          {/* Grid */}
          <div className="absolute inset-0 flex items-center justify-center p-4 z-10">
             <div className="grid-container" ref={gridRef}>
                <svg className="connections-layer w-full h-full">
                    {path.length > 0 && (
                        <path
                            d={getSvgPath()}
                            fill="none"
                            stroke="rgba(34, 211, 238, 0.6)"
                            strokeWidth="6"
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            className="drop-shadow-[0_0_10px_rgba(34,211,238,0.8)]"
                        />
                    )}
                </svg>

                {grid.map((row, r) => (
                    row.map((cell, c) => {
                        const isSelected = path.some(p => p.r === r && p.c === c);
                        const isDim = path.length > 0 && !isSelected && cell.color !== path[0].color;

                        return (
                            <div
                                key={cell.id}
                                data-r={r}
                                data-c={c}
                                onMouseDown={() => handleStart(r, c)}
                                onTouchStart={() => handleStart(r, c)}
                                className="relative flex items-center justify-center cursor-pointer"
                            >
                                <div
                                    className={`orb w-10 h-10 md:w-14 md:h-14 ${isSelected ? 'active' : ''} ${isDim ? 'dim' : ''}`}
                                    style={{
                                        backgroundColor: cell.color,
                                        transform: `scale(${cell.scale * (isSelected ? 1.1 : 1)})`,
                                        opacity: cell.scale,
                                        boxShadow: isSelected ? `0 0 20px ${cell.color}` : 'none'
                                    }}
                                ></div>
                            </div>
                        );
                    })
                ))}

                {particles.map(p => (
                    <div
                        key={p.id}
                        className="particle w-4 h-4"
                        style={{
                            left: p.left, top: p.top,
                            backgroundColor: p.color,
                            '--tx': p.tx, '--ty': p.ty,
                            boxShadow: `0 0 10px ${p.color}`
                        }}
                    />
                ))}
             </div>
          </div>

          {/* Floating Message */}
          {message && (
             <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none z-30">
                 <div className="text-4xl text-cyan-400 font-black tracking-widest text-glow fade-in" style={{ fontFamily: '"Black Ops One", cursive' }}>
                    {message.text}
                 </div>
             </div>
          )}

          {/* Pause Menu (Standardized) */}
          {isPaused && (
            <div className="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center p-6">
              <h2 className="text-4xl font-black text-white mb-8 tracking-widest">PAUSED</h2>
              <div className="w-full max-w-xs space-y-2 mb-8">
                <SettingBtn label="SOUND" active={settings.sound} onClick={toggleSound} icon={settings.sound ? IconVolume : IconVolumeOff} />
                <SettingBtn label="HAPTICS" active={settings.haptics} onClick={toggleHaptics} icon={IconZap} />
                <SettingBtn label="CRT EFFECT" active={settings.crt} onClick={toggleCRT} icon={IconMonitor} />
                <SettingBtn label="COLOR BLIND" active={settings.colorBlind} onClick={toggleColorBlind} icon={IconEye} />
              </div>
              <div className="flex flex-col gap-4 w-full max-w-xs">
                <button onClick={togglePause} className="w-full py-4 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded border-b-4 border-cyan-800 active:border-b-0 active:translate-y-1 transition-all">RESUME</button>
                <button onClick={() => { togglePause(); initGame(); }} className="w-full py-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded border-b-4 border-red-800 active:border-b-0 active:translate-y-1 transition-all">RESTART</button>
                <a href="index.html" className="w-full py-4 bg-gray-700 hover:bg-gray-600 text-white font-bold rounded border-b-4 border-gray-900 active:border-b-0 active:translate-y-1 transition-all text-center">EXIT TO MENU</a>
              </div>
            </div>
          )}

          {/* Start Screen (Standardized) */}
          {!gameStarted && (
            <div className="absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-50 px-6">
              <h2 className="text-5xl font-bold text-cyan-400 mb-6 text-center" style={{ fontFamily: '"Black Ops One", cursive' }}>COHERENCE</h2>
              <div className="w-full max-w-xs bg-gray-800 rounded p-4 border border-gray-700 mb-8 text-center">
                 <div className="text-gray-400 text-sm mb-2 font-bold uppercase">Instructions</div>
                 <ul className="text-gray-300 space-y-2 font-mono text-sm text-left list-disc pl-6">
                    <li>Connect matching orbs.</li>
                    <li>Move with the <span className="text-cyan-400 font-bold">rhythm</span>.</li>
                    <li>Release on the exhale for bonus.</li>
                 </ul>
              </div>
              <button onClick={initGame} className="px-12 py-5 text-xl bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded shadow-[0_0_30px_rgba(34,211,238,0.5)] active:scale-95 transition-transform">START</button>
              <a href="index.html" className="mt-8 text-gray-500 hover:text-white">BACK TO MENU</a>
            </div>
          )}

        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
